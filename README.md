# DevOps Final Project – Инфраструктура VPN и PKI

Учебный проект: развёртывание минимальной, но воспроизводимой инфраструктуры для небольшой компании.  
Цель – показать умение проектировать и автоматизировать: PKI/CA, VPN, мониторинг, бэкапы и документацию.

---

## Требования к инфраструктуре

- Облачный провайдер: Yandex Cloud. (или аналог)  
- ОС серверов: Ubuntu 24.04 LTS.  
- Доступ по SSH по ключам (без паролей).  
- Отдельная VPC и подсеть для инфраструктуры (например, `10.10.0.0/24`).  
- Возможность создать несколько ВМ:
  - CA‑сервер (удостоверяющий центр).
  - VPN‑сервер (OpenVPN).
  - Сервер мониторинга (Prometheus + Alertmanager).
  - Сервер(ы) для бэкапов.

---

## Предварительно устанавливаемые инструменты

**На локальной машине (администратор):**

- SSH‑клиент (OpenSSH, PuTTY или аналог).  
- Git.  
- Браузер с доступом к консоли Yandex Cloud.

**На серверах (через скрипты/пакет):**

- `easy-rsa` – управление PKI.  
- `openssl` – операции с сертификатами.  
- `ufw` – базовый firewall.  
- `bash` – оболочка для скриптов.

---

## Состав серверов проекта (план)

На текущем этапе реализован первый компонент – CA‑сервер. В дальнейшем планируются:

- **CA‑сервер (PKI)**  
  - Роль: выдача и отзыв сертификатов для VPN и других сервисов.  
  - Особенности: отдельная ВМ, минимальный набор открытых портов (только SSH), хранит приватный ключ CA и PKI.

- **VPN‑сервер (OpenVPN)**  
  - Роль: точка входа во внутреннюю сеть компании.  
  - Использует сертификат, подписанный CA.

- **Сервер мониторинга (Prometheus + Alertmanager)**  
  - Роль: сбор метрик, алерты по состоянию VPN и инфраструктуры.

- **Сервер(ы) бэкапов**  
  - Роль: хранение данных, конфигураций, скриптов и deb‑пакетов, сценарии восстановления.

---

## Схема взаимодействия компонентов (логика)

Концептуально взаимодействие компонентов выглядит так:

- Пользовательский ПК ⇄ VPN‑сервер (OpenVPN по TLS, аутентификация по сертификатам).  
- VPN‑сервер доверяет только сертификатам, подписанным CA.  
- CA‑сервер не доступен из интернета как сервис, используется только администратором для:
  - генерации корневого сертификата;
  - подписи CSR (серверных и клиентских);
  - отзыва сертификатов (CRL).  
- Мониторинг опрашивает VPN‑сервер и другие ВМ по защищённым каналам (доступ только из собственной подсети).

На Этапе 1 реализован только CA‑сервер и его автоматизация.

---

## Этап 1: Удостоверяющий центр (CA)

### Что делает CA‑сервер

- Развёрнут в Yandex Cloud на отдельной ВМ с Ubuntu 24.04 LTS.  
- Имеет только SSH‑доступ (22/tcp), остальные входящие порты закрыты UFW.  
- Содержит PKI‑структуру и Root CA (самоподписанный сертификат).

### Скрипты автоматизации (`scripts/`)

В папке `scripts/` находятся скрипты для автоматизации развёртывания и обслуживания CA:

- **`install_ca.sh`**  
  - Устанавливает `easy-rsa`, `openssl`, `ufw`.  
  - Создаёт каталог `/etc/pki` с правами `700`.  
  - Настраивает UFW: `deny` incoming, `allow` outgoing, разрешает SSH (22/tcp).  
  - Создаёт symlink `easy-rsa` → `/usr/share/easy-rsa/easyrsa`.

- **`init_ca.sh`**  
  - Инициализирует PKI в `/etc/pki/pki` (`easy-rsa init-pki`).  
  - Создаёт файл `/etc/pki/vars` с политикой PKI (страна, город, организация, алгоритм, сроки действия).  
  - Запускает `easy-rsa build-ca` и создаёт корневой сертификат (`ca.crt`) и ключ (`ca.key`).  
  - При повторном запуске не пересоздаёт существующий CA.

- **`sign_csr.sh`**  
  - Подписывает запросы на сертификаты (CSR) от серверов и клиентов.  
  - Интерфейс: `sign_csr.sh server <csr>` или `sign_csr.sh client <csr>`.  
  - Импортирует CSR в PKI и вызывает `easy-rsa sign-req`.  
  - Сохраняет выданный сертификат и корневой сертификат в удобном каталоге.

- **`revoke_cert.sh`**  
  - Отзывает сертификат по Common Name.  
  - Вызывает `easy-rsa revoke` и `easy-rsa gen-crl`, обновляя `crl.pem`.

---

## deb‑пакет (`devops-ca-tools`)

Папка `debian/` содержит файлы для сборки deb‑пакета `devops-ca-tools`:

- `control` – метаданные пакета (имя, версия, зависимости, описание).  
- `postinst` – создаёт `/etc/pki`, настраивает права и symlink для `easy-rsa`.  
- `postrm`, `rules`, `changelog`, `compat` – служебные файлы для сборки.

Собранный пакет размещён в `artifacts/devops-ca-tools_1.0-1_all.deb`.

**Назначение пакета:**

- Установить базовую конфигурацию для CA (каталоги, зависимости, окружение Easy‑RSA).  
- Снизить количество ручных действий при развёртывании новой ВМ под CA.

Подробнее про Этап 1 и артефакты описано в `docs/stage1-pki.md`.

---

## Как развернуть CA на новой ВМ (проверено)

1. Поднять новую ВМ в Yandex Cloud (Ubuntu 24.04, SSH по ключу).  

2. Скопировать на неё deb‑пакет и репозиторий (команда запускается на локальной машине):

- scp artifacts/devops-ca-tools_1.0-1_all.deb user@<ip>:~
- scp -r devops-final-pki-ca user@<ip>:~

3. На ВМ установить зависимости и deb‑пакет:

- sudo apt update
- sudo apt install -y easy-rsa openssl ufw bash
- sudo dpkg -i devops-ca-tools_1.0-1_all.deb

4. Скопировать скрипты в системный путь и запустить автоматизацию:

- cd ~/devops-final-pki-ca/scripts
- sudo cp install_ca.sh init_ca.sh sign_csr.sh revoke_cert.sh /usr/local/sbin/
- sudo chmod +x /usr/local/sbin/*.sh

- sudo install_ca.sh
- sudo init_ca.sh

5. Проверить, что CA создан:

- sudo ls /etc/pki/pki
- sudo ls -l /etc/pki/pki/private/ca.key
- sudo openssl x509 -in /etc/pki/pki/ca.crt -noout -subject -issuer -dates

После выполнения этих шагов на новой ВМ автоматически развёрнут удостоверяющий центр с такой же структурой PKI, как на исходном сервере.  

---

Подробное текстовое описание Этапа 1 (роль CA, структура PKI, скрипты, deb‑пакет и проверка воспроизводимости) находится в файле `docs/stage1-pki.md`.